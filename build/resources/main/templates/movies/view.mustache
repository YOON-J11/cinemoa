{{> common/header }}
<link rel="stylesheet" href="/css/movies.css" />

<div class="container movies">
    <div class="content-wrap">
        <div class="content">
            <div class="movie-detail">
                {{#movie}}
                    <div class="admin-btn">
                        <a href="/movies/{{movieId}}/edit" class="btn btn-primary">수정</a>
                        <button type="button" class="btn btn-danger" onclick="deleteMovie({{movieId}})">삭제</button>
                    </div>

                    <div class="movie-info-wrap">
                        <div class="poster">
                            {{#mainImageUrl}}
                                <img src="/images/movie/{{mainImageUrl}}" class="img-fluid rounded" alt="{{title}}">
                            {{/mainImageUrl}}
                            {{^mainImageUrl}}
                                <div class="bg-light text-center py-5 rounded">이미지 없음</div>
                            {{/mainImageUrl}}
                        </div>

                        <div class="movie-info">
                            <div class="movie-info-top">
                                <h2 class="tit">{{title}}</h2>
                                <ul class="info1">
                                    <li>
                                        <p class="date">
                                            {{#releaseDate}}<span class="bold600 format-date">{{releaseDate}}</span> 개봉{{/releaseDate}}
                                            {{^releaseDate}}미정{{/releaseDate}}
                                        </p>
                                    </li>
                                    <li class="flex-center ">
                                        <img src="https://www.lottecinema.co.kr/NLCHS/Content/images/icon/icon_clock_black.svg">
                                        <span class="time bold600 pl-5">{{runningTime}}</span>분
                                    </li>
                                    <li class="age bold600">{{ageRating}}</li>
                                </ul>

                                <div class="info2">
                                    <p>감독 : {{director}}</p>
                                    <p>배우 : {{actors}}</p>
                                    <p>장르 : {{genre}}</p>
                                </div>

                                <div class="info3">
                                    <a href="{{^loginMember}}/member/login{{/loginMember}}" class="like">
                                        <div class="like-btn" data-movie-id="{{movieId}}">
                                            <button class="heart-button {{#loginMember}}{{#likedByCurrentUser}}active{{/likedByCurrentUser}}{{/loginMember}}">
                                                <svg width="15px" height="15px" viewBox="0 0 15 15" version="1.1" id="heart" xmlns="http://www.w3.org/2000/svg">
                                                    <path d="M13.91,6.75c-1.17,2.25-4.3,5.31-6.07,6.94c-0.1903,0.1718-0.4797,0.1718-0.67,0C5.39,12.06,2.26,9,1.09,6.75&#xA;&#x9;C-1.48,1.8,5-1.5,7.5,3.45C10-1.5,16.48,1.8,13.91,6.75z" stroke="black"/>
                                                </svg>
                                            </button>
                                            <span class="likesCount">{{likesCount}}</span>
                                        </div>
                                    </a>
                                    <a href="/ticketing/{{movieId}}" class="ticketing-btn">예매하기</a>
                                </div>
                            </div>

                            <div class="info4 score">
                                <div class="rate">
                                    <h5>실관람 평점</h5>
                                    <p class="progress">
                                        <span aria-valuenow="{{positivePercentage}}" aria-valuemin="0" aria-valuemax="100">{{positivePercentage}}%</span>
                                    </p>
                                </div>
                                <div class="reservation">
                                    <h5>예매율</h5>
                                    <p><span>{{rank}}위</span>(<span class="rating">{{reservationRate}}%</span>)</p>
                                </div>
                                <div class="audience">
                                    <h5>누적관객수</h5>
                                    <p><span class="audience-counting">{{audienceCount}}</span></p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="movie-cont-wrap">
                        <ul class="tab">
                            <li class="on">상세정보</li>
                            <li>관람평</li>
                            <li>예고편/스틸컷</li>
                        </ul>

                        <ul class="tab_cont">
                            <!-- 상세정보 탭 -->
                            <li class="on">
                                <div class="inner">
                                    <p class="movie-cont">{{{content}}}</p>

                                    <!-- 리뷰 영역 -->
                                    <div class="review-top">
                                        <div class="alert-info">
                                            <p class="pb-25">영화의 어떤 점이 좋았는지 이야기해주세요!</p>

                                            {{#loginMember}}
                                                <button type="button"
                                                        class="btn-review"
                                                        data-movie-id="{{movieId}}"
                                                        data-canwrite="{{canWriteReview}}">
                                                    실관람평 작성하기
                                                </button>
                                            {{/loginMember}}
                                            {{^loginMember}}
                                                <a href="/member/login" class="">실관람평 작성하기</a>
                                            {{/loginMember}}
                                        </div>
                                        <h4 class="bold600">실관람평 {{reviews.size}}</h4>
                                    </div>

                                    <div class="review-list">
                                        {{#reviews}}
                                            <div class="card">
                                                <div class="card-inner">
                                                    <div class="cart-cont">
                                                        <p class="user bold600">{{userName}}</p>
                                                        <p class="date format-date">{{createdAt}}</p>
                                                        <p class="card-text">{{{content}}}</p>
                                                        {{#deletable}}
                                                            <div class="btn-wrap">
                                                                <button class="edit-review-btn" data-review-id="{{reviewId}}">수정</button>
                                                                <a href="/reviews/delete/{{reviewId}}?movieId={{movieId}}"
                                                                class="btn btn-sm btn-outline-danger"
                                                                onclick="return confirm('정말로 이 리뷰를 삭제하시겠습니까?');">삭제</a>
                                                            </div>
                                                        {{/deletable}}
                                                    </div>
                                                    <h5 class="card-title">
                                                        {{#isPositive}}<span class="badge bg-success">좋았어요</span>{{/isPositive}}
                                                        {{^isPositive}}<span class="badge bg-danger">별로였어요</span>{{/isPositive}}
                                                    </h5>
                                                </div>
                                            </div>
                                        {{/reviews}}

                                        {{^reviews}}
                                            <div class="alert-info pt-20">아직 등록된 리뷰가 없습니다. 첫 번째 리뷰를 작성해보세요!</div>
                                        {{/reviews}}
                                    </div>
                                </div>
                            </li>

                            <!-- 관람평 탭 -->
                            <li>
                                <div class="inner">
                                    <div class="review-top">
                                        <div class="alert-info">
                                            <p class="pb-25">영화의 어떤 점이 좋았는지 이야기해주세요!</p>

                                            {{#loginMember}}
                                                <button type="button"
                                                        class="btn-review"
                                                        data-movie-id="{{movieId}}"
                                                        data-canwrite="{{canWriteReview}}">
                                                    실관람평 작성하기
                                                </button>
                                            {{/loginMember}}
                                            {{^loginMember}}
                                                <a href="/member/login" class="">실관람평 작성하기</a>
                                            {{/loginMember}}
                                        </div>
                                        <h4 class="bold600">실관람평 {{reviews.size}}</h4>
                                    </div>

                                    <div class="review-list">
                                        {{#reviews}}
                                            <div class="card">
                                                <div class="card-inner">
                                                    <div class="cart-cont">
                                                        <p class="user bold600">{{userName}}</p>
                                                        <p class="date format-date">{{createdAt}}</p>
                                                        <p class="card-text">{{{content}}}</p>
                                                        {{#deletable}}
                                                            <div class="btn-wrap">
                                                                <button class="edit-review-btn" data-review-id="{{reviewId}}">수정</button>
                                                                <a href="/reviews/delete/{{reviewId}}?movieId={{movieId}}"
                                                                class="btn btn-sm btn-outline-danger"
                                                                onclick="return confirm('정말로 이 리뷰를 삭제하시겠습니까?');">삭제</a>
                                                            </div>
                                                        {{/deletable}}
                                                    </div>
                                                    <h5 class="card-title">
                                                        {{#isPositive}}<span class="badge bg-success">좋았어요</span>{{/isPositive}}
                                                        {{^isPositive}}<span class="badge bg-danger">별로였어요</span>{{/isPositive}}
                                                    </h5>
                                                </div>
                                            </div>
                                        {{/reviews}}

                                        {{^reviews}}
                                            <div class="alert-info pt-20">아직 등록된 리뷰가 없습니다. 첫 번째 리뷰를 작성해보세요!</div>
                                        {{/reviews}}
                                    </div>
                                </div>
                            </li>

                            <!-- 예고편/스틸컷 탭 -->
                            <li class="media">
                                {{#videoUrl}}
                                    <h4 class="pt-10 pb-20">트레일러</h4>
                                    <div class="embed-responsive">
                                        <iframe class="embed-responsive-item" src="{{videoUrl}}" allowfullscreen style="width:100%; height:100%;"></iframe>
                                    </div>
                                {{/videoUrl}}

                                {{#detailImageUrls}}
                                    <h4 class="pt-50 pb-20">포스터/스틸컷</h4>
                                    <div class="detail-images-gallery">
                                        {{#detailImageUrlList}}
                                            <div class="detail-image-item">
                                                <img src="/images/movie/{{.}}" class="img-fluid rounded" alt="스틸컷">
                                            </div>
                                        {{/detailImageUrlList}}
                                    </div>
                                {{/detailImageUrls}}
                            </li>
                        </ul>
                    </div>
                {{/movie}}
            </div>
        </div>
    </div>
</div>

<!-- 리뷰 작성 모달 (동적 내용 주입) -->
<div class="modal fade" id="reviewModal" tabindex="-1" aria-labelledby="reviewModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content"><!-- 여기 내용을 JS로 교체합니다 --></div>
    </div>
</div>

<!-- 리뷰 작성 불가 안내 모달(고정 문구) -->
<div class="modal fade" id="notEligibleModal" tabindex="-1" aria-labelledby="notEligibleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-body text-center">예매한 분만 리뷰 작성이 가능합니다.</div>
        </div>
    </div>
</div>

<!-- Bootstrap 5 -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
      /* ----- 탭 ----- */
      const tabHeaders = document.querySelectorAll('.tab li');
      const tabContents = document.querySelectorAll('.tab_cont li');
      tabHeaders.forEach((header, idx) => {
        header.addEventListener('click', function () {
          tabHeaders.forEach(h => h.classList.remove('on'));
          this.classList.add('on');
          tabContents.forEach(c => c.classList.remove('on'));
          tabContents[idx].classList.add('on');
        });
      });

      /* ----- 리뷰 버튼 클릭: canWrite 분기 → 모달 제어 ----- */
      document.querySelectorAll('.btn-review').forEach(btn => {
        btn.addEventListener('click', function (e) {
          e.preventDefault();

          const canWrite = (this.getAttribute('data-canwrite') === 'true');
          const movieId  = this.getAttribute('data-movie-id');

          if (!canWrite) {
              alert("예매한 분만 리뷰 작성이 가능합니다.");
              return;
            }


          fetch(`/reviews/check-review?movieId=${movieId}`)
            .then(res => res.ok ? res.text() : Promise.reject('서버 응답 오류'))
            .then(text => {
              let data = null;
              try { data = text ? JSON.parse(text) : null; } catch (_) { data = null; }

              const modalEl = document.getElementById('reviewModal');
              const modal   = new bootstrap.Modal(modalEl);

              const loader = data
                ? fetch(`/reviews/edit-fragment?reviewId=${data.reviewId}`)
                : fetch(`/reviews/new-fragment?movieId=${movieId}`);

              return loader.then(r => r.text()).then(html => {
                modalEl.querySelector('.modal-content').innerHTML = html;
                modal.show();
              });
            })
            .catch(err => {
              console.error('리뷰 체크 중 오류:', err);
              alert('리뷰 정보를 불러오는데 실패했습니다.');
            });
        });
      });

      /* ----- 리뷰 수정 버튼 (동적) ----- */
      document.addEventListener('click', function (e) {
        const btn = e.target.closest('.edit-review-btn');
        if (!btn) return;
        const reviewId = btn.getAttribute('data-review-id');
        fetch(`/reviews/edit-fragment?reviewId=${reviewId}`)
          .then(r => r.text())
          .then(html => {
            const modalEl = document.getElementById('reviewModal');
            modalEl.querySelector('.modal-content').innerHTML = html;
            new bootstrap.Modal(modalEl).show();
          })
          .catch(err => {
            console.error('수정 폼 로드 실패:', err);
            alert('수정 폼을 불러오는데 실패했습니다.');
          });
      });

      /* ----- 좋아요 토글(프론트) + 서버 반영 ----- */
      const likeWrappers = document.querySelectorAll('.like-btn[data-movie-id]');
      likeWrappers.forEach(wrap => {
        const movieId = wrap.getAttribute('data-movie-id');
        const heart   = wrap.querySelector('.heart-button');
        const countEl = wrap.querySelector('.likesCount');
        if (!heart || !countEl) return;

        heart.addEventListener('click', function () {
          fetch(`/api/movies/${movieId}/like`, { method: 'POST', headers: {'Content-Type':'application/json'} })
            .then(res => res.ok ? res.text() : res.text().then(t => Promise.reject(t || '좋아요 처리 오류')))
            .then(msg => {
              alert(msg);
              let cur = parseFormattedNumber(countEl.textContent);
              if (msg.includes('추가되었습니다')) { cur++; heart.classList.add('active'); }
              else if (msg.includes('취소되었습니다')) { cur--; heart.classList.remove('active'); }
              countEl.textContent = formatNumber(cur);
            })
            .catch(err => {
              console.error('좋아요 에러:', err);
              alert('좋아요 처리 중 에러가 발생했습니다: ' + err);
            });
        });
      });

      /* ----- 숫자 포맷(좋아요, 관객수) ----- */
      document.querySelectorAll('.likesCount').forEach(el => {
        const t = el.textContent.trim();
        if (!/[KMGT]$/.test(t)) {
          const n = parseInt(t.replace(/,/g, ''), 10);
          if (!isNaN(n)) el.textContent = formatNumber(n);
        }
      });

      document.querySelectorAll(".audience-counting").forEach(el => {
        const original = el.textContent.trim();
        el.textContent = formatAudienceCount(original);
      });

      /* ----- 나머지 포맷들 ----- */
      document.querySelectorAll('.age').forEach(el => el.textContent = convertAgeRating(el.textContent));
      document.querySelectorAll('.rating').forEach(el => {
        const val = parseFloat(el.textContent);
        if (!isNaN(val)) el.textContent = (Math.floor(val * 10) / 10) + (el.textContent.includes('%') ? '%' : '');
      });
      document.querySelectorAll('.format-date').forEach(el => {
        const s = el.textContent;
        if (s && s.trim() !== '') el.textContent = formatDate(s);
      });
    });

    /* ===== 공통 유틸 ===== */
    function formatNumber(num) {
      if (num < 1000) return num.toString();
      if (num < 1_000_000) return (Math.floor(num / 100) / 10) + 'K';
      if (num < 1_000_000_000) return (Math.floor(num / 100_000) / 10) + 'M';
      if (num < 1_000_000_000_000) return (Math.floor(num / 100_000_000) / 10) + 'G';
      return (Math.floor(num / 100_000_000_000) / 10) + 'T';
    }
    function parseFormattedNumber(text) {
      const m = text.trim().match(/([0-9.]+)([KMGT]?)$/);
      if (!m) return 0;
      const v = parseFloat(m[1]); const u = m[2];
      switch (u) {
        case 'K': return v * 1_000;
        case 'M': return v * 1_000_000;
        case 'G': return v * 1_000_000_000;
        case 'T': return v * 1_000_000_000_000;
        default:  return v;
      }
    }
    function formatAudienceCount(count) {
      if (typeof count === 'string' && /[만명]/.test(count)) return count;
      const n = parseInt((count || '').toString().replace(/,/g, ''), 10);
      if (isNaN(n)) return count;
      if (n >= 10000) return (n / 10000).toFixed(1).replace(/\.0$/, '') + '만명';
      return n.toLocaleString() + '명';
    }
    function convertAgeRating(text) {
      switch ((text || '').trim().toLowerCase()) {
        case 'all': return '전체관람가';
        case '12':  return '12세이상관람가';
        case '15':  return '15세이상관람가';
        case '19':  return '청소년관람불가';
        default:    return text;
      }
    }
    function formatDate(dateString) {
      if (!dateString) return '';
      const datePart = dateString.split('T')[0];
      return datePart.replaceAll('-', '.');
    }

    /* 삭제 */
    function deleteMovie(movieId) {
      if (!confirm('정말로 이 영화를 삭제하시겠습니까?')) return;
      fetch(`/api/movies/${movieId}`, { method: 'DELETE' })
        .then(r => {
          if (r.ok) { alert('영화를 성공적으로 삭제했습니다.'); window.location.href = '/movies'; }
          else { alert('영화 삭제에 실패했습니다. 다시 시도해주세요.'); }
        })
        .catch(err => { alert('영화 삭제 중 오류가 발생했습니다.'); console.error(err); });
    }
</script>

{{> common/footer }}

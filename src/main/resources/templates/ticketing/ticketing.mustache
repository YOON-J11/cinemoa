<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>영화예매</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .inactive { opacity: 0.6; pointer-events: none; }

        .movie-item,
        .cinema-button,
        .date-optionbutton {
          cursor: pointer;
          border: 1px solid #ddd;
          border-radius: 5px;
          padding: 10px;
          transition: 0.3s;
          background-color: #fff;
        }

        .movie-item:hover,
        .cinema-button:hover,
        .date-optionbutton:hover {
          border-color: #0d6efd;
          box-shadow: 0 0 5px rgba(13,110,253,0.3);
        }

        .movie-item.selected,
        .cinema-button.btn-primary,
        .date-optionbutton.btn-primary {
          background-color: #f0f7ff;
          border-color: #007bff;
          color: #000;
        }

        .time-slot {
          cursor: pointer;
          border: 1px solid #ddd;
          border-radius: 5px;
          padding: 10px;
          margin-bottom: 10px;
          transition: 0.3s;
        }

        .time-slot.selected {
          background-color: #007bff;
          color: white;
        }
    </style>
</head>
<body>
{{>common/header}}

<div class="container mt-5">
    <h1 class="mb-4">영화예매</h1>

    <!-- 1. 영화 선택 -->
    <div id="step1">
        <h3>1. 영화 선택</h3>
        <div class="row" id="movieList">
            {{#nowShowingMovies}}
                <div class="col-md-4 mb-3">
                    <div class="movie-item" data-movie-id="{{movieId}}">
                        <div class="d-flex">
                            <div class="flex-shrink-0">
                                {{#mainImageUrl}}
                                    <img src="/images/movie/{{mainImageUrl}}" class="img-fluid rounded" style="height:150px;" alt="{{title}}">
                                {{/mainImageUrl}}
                                {{^mainImageUrl}}
                                    <div class="bg-light text-center py-5 rounded" style="width:100px;height:150px;">이미지없음</div>
                                {{/mainImageUrl}}
                            </div>
                            <div class="flex-grow-1 ms-3">
                                <h5>{{title}}</h5>
                                <p><small>{{genre}} | {{runningTime}}분 | {{ageRating}}</small></p>
                                <p><small>예매율: <span class="rating-value">{{reservationRate}}</span>%</small></p>
                            </div>
                        </div>
                    </div>
                </div>
            {{/nowShowingMovies}}
        </div>
        <input type="hidden" id="selectedMovieId" value="{{selectedMovieId}}">
    </div>

    <!-- 2. 영화관 선택 -->
    <div id="step2" class="mt-4 inactive">
        <h3>2. 영화관 선택</h3>
        <div id="cinemaList" class="row mt-2">
            {{#cinemas}}
                <div class="col-md-3 mb-2">
                    <button type="button" class="btn btn-outline-secondary w-100 cinema-button" data-cinema-id="{{cinemaId}}">
                        {{name}} ({{region}})
                    </button>
                </div>
            {{/cinemas}}
        </div>
    </div>

    <!-- 3. 날짜 선택 -->
    <div id="step3" class="mt-4 inactive">
        <h3>3. 날짜 선택</h3>
        <div id="availableDates" class="row"></div>
        <input type="hidden" id="selectedDate">
    </div>

    <!-- 4. 시간 선택 -->
    <div id="step4" class="mt-4 inactive">
        <h3>4. 시간 선택</h3>
        <div id="timeSlots" class="row"></div>
        <input type="hidden" id="selectedShowtime">
        <button type="button" class="btn btn-success mt-3" id="goToSeatSelection" disabled>좌석선택하기</button>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
      let currentStep = 1;
      let selectedMovieId = document.getElementById('selectedMovieId').value || null;
      let selectedCinemaId = null;
      let selectedDate = null;
      let selectedShowtimeId = null;

      const updateStepVisibility = () => {
        for (let i = 2; i <= 4; i++) {
          document.getElementById('step' + i).classList.toggle('inactive', currentStep < i);
        }
      };

      document.querySelectorAll('.movie-item').forEach(item => {
        item.addEventListener('click', () => {
          document.querySelectorAll('.movie-item').forEach(el => el.classList.remove('selected'));
          item.classList.add('selected');
          selectedMovieId = item.dataset.movieId;
          document.getElementById('selectedMovieId').value = selectedMovieId;
          selectedCinemaId = null;
          selectedDate = null;
          selectedShowtimeId = null;
          document.querySelectorAll('.cinema-button').forEach(b => b.classList.remove('btn-primary'));
          document.getElementById('availableDates').innerHTML = '';
          document.getElementById('timeSlots').innerHTML = '';
          document.getElementById('goToSeatSelection').disabled = true;
          currentStep = 2;
          updateStepVisibility();
        });
      });

      document.getElementById('cinemaList').addEventListener('click', e => {
        const btn = e.target.closest('.cinema-button');
        if (!btn) return;
        document.querySelectorAll('.cinema-button').forEach(b => b.classList.remove('btn-primary'));
        btn.classList.add('btn-primary');
        selectedCinemaId = btn.dataset.cinemaId;
        selectedDate = null;
        selectedShowtimeId = null;
        document.getElementById('availableDates').innerHTML = '';
        document.getElementById('timeSlots').innerHTML = '';
        document.getElementById('goToSeatSelection').disabled = true;
        fetchAvailableDates(selectedMovieId, selectedCinemaId);
        currentStep = 3;
        updateStepVisibility();
      });

      document.getElementById('availableDates').addEventListener('click', e => {
        const btn = e.target.closest('.date-optionbutton');
        if (!btn) return;
        document.querySelectorAll('.date-optionbutton').forEach(b => b.classList.remove('btn-primary'));
        btn.classList.add('btn-primary');
        selectedDate = btn.dataset.date;
        document.getElementById('selectedDate').value = selectedDate;
        selectedShowtimeId = null;
        document.getElementById('goToSeatSelection').disabled = true;
        document.getElementById('timeSlots').innerHTML = '';
        fetchShowtimes(selectedMovieId, selectedCinemaId, selectedDate);
        currentStep = 4;
        updateStepVisibility();
      });

      document.getElementById('timeSlots').addEventListener('click', e => {
        const slot = e.target.closest('.time-slot');
        if (!slot) return;
        document.querySelectorAll('.time-slot').forEach(s => s.classList.remove('selected'));
        slot.classList.add('selected');
        selectedShowtimeId = slot.dataset.showtimeId;
        document.getElementById('selectedShowtime').value = selectedShowtimeId;
        document.getElementById('goToSeatSelection').disabled = false;
      });

      document.getElementById('goToSeatSelection').addEventListener('click', () => {
        if (!selectedShowtimeId) return;
        window.location.href = `/ticketing/showtime/${selectedShowtimeId}/seats`;
      });

      function renderWeekDatesWithAvailability(availableDates) {
        const container = document.getElementById('availableDates');
        container.innerHTML = '';
        const today = new Date();
        const todayStr = today.toISOString().split('T')[0];

        for (let i = 0; i < 7; i++) {
          const dateObj = new Date(today);
          dateObj.setDate(today.getDate() + i);
          const dateStr = dateObj.toISOString().split('T')[0];

          const col = document.createElement('div');
          col.className = 'col-md-2 mb-2';

          const btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'btn w-100 date-optionbutton';
          btn.dataset.date = dateStr;
          btn.textContent = dateStr;

          col.appendChild(btn);
          container.appendChild(col);

          if (dateStr === todayStr) {
            btn.classList.add('btn-primary');
            selectedDate = dateStr;
            document.getElementById('selectedDate').value = selectedDate;
            currentStep = 4;
            updateStepVisibility();
            if (selectedMovieId && selectedCinemaId) {
              fetchShowtimes(selectedMovieId, selectedCinemaId, selectedDate);
            }
          }
        }
      }

      function fetchAvailableDates(movieId, cinemaId) {
        fetch(`/ticketing/api/dates?movieId=${movieId}&cinemaId=${cinemaId}`)
          .then(res => res.json())
          .then(dates => renderWeekDatesWithAvailability(dates || []));
      }

      function fetchShowtimes(movieId, cinemaId, date) {
        fetch(`/ticketing/api/showtimes?movieId=${movieId}&cinemaId=${cinemaId}&date=${date}`)
          .then(res => res.json())
          .then(showtimes => {
            const container = document.getElementById('timeSlots');
            container.innerHTML = '';
            if (showtimes.length === 0) {
              container.innerHTML = `<div class="col-12"><div class="alert alert-warning text-center">조회 가능한 상영시간이 없습니다.<br>조건을 변경해주세요.</div></div>`;
              document.getElementById('goToSeatSelection').disabled = true;
            } else {
              showtimes.forEach(show => {
                const start = new Date(show.startTime);
                const end = new Date(show.endTime);
                const timeDiv = document.createElement('div');
                timeDiv.className = 'col-md-4 mb-3';
                timeDiv.innerHTML = `<div class="time-slot" data-showtime-id="${show.showtimeId}"><strong>${start.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}-${end.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</strong><p>${show.screenName}<br>${Number(show.price).toLocaleString()}원</p></div>`;
                container.appendChild(timeDiv);
              });
            }
          });
      }

      updateStepVisibility();
    });
</script>
</body>
</html>

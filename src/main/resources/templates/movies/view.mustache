<link rel="stylesheet" href="/css/movies.css" />
{{> common/header }}
<div class="container movie">
    <div class="content-wrap">
        <div class="content">
            <div class="movie-detail">
                {{#movie}}
                    <div class="movie-info-wrap">
                        <div class="poster">
                            {{#mainImageUrl}}
                                <img src="/images/movie/{{mainImageUrl}}" class="img-fluid rounded" alt="{{title}}">
                            {{/mainImageUrl}}
                            {{^mainImageUrl}}
                                <div class="bg-light text-center py-5 rounded" >이미지 없음</div>
                            {{/mainImageUrl}}
                        </div>
                        <div class="movie-info">
                           <h2 class="tit">{{title}}</h2>
                            <ul class="info1">
                                <li>
                                    <p class="date">
                                        {{#releaseDate}}<span class="bold600 format-date">{{releaseDate}}</span> 개봉{{/releaseDate}}
                                        {{^releaseDate}}미정{{/releaseDate}}
                                    </p>
                                </li>
                                <li class="flex-center "><img src="https://www.lottecinema.co.kr/NLCHS/Content/images/icon/icon_clock_black.svg"><span class="time bold600 pl-5">{{runningTime}}</span>분</li>
                                <li class="age">{{ageRating}}</li>
                            </ul>
                            <div class="info2">
                                <p>감독: {{director}}</p>
                                <p>배우: {{actors}}</p>
                                <p>장르: {{genre}}</p>
                            </div>
                            <div class="info3">
                                <div class="like">
                                    <div class="like-btn">
                                        <button class="heart-button">
                                            <svg width="15px" height="15px" viewBox="0 0 15 15" version="1.1" id="heart" xmlns="http://www.w3.org/2000/svg">
                                                <path d="M13.91,6.75c-1.17,2.25-4.3,5.31-6.07,6.94c-0.1903,0.1718-0.4797,0.1718-0.67,0C5.39,12.06,2.26,9,1.09,6.75&#xA;&#x9;C-1.48,1.8,5-1.5,7.5,3.45C10-1.5,16.48,1.8,13.91,6.75z" stroke="black"/>
                                            </svg>
                                        </button>
                                        <span class="likesCount">{{likesCount}}</span>
                                    </div>
                                </div>
                            </div>
                            <div class="info4 score">
                                <div class="rate">
                                    <h5>실관람 평점</h5>
                                    <p><span class="rating">{{rating}}</span>%</p>
                                </div>
                                <div class="reservation">
                                    <h5>예매율</h5>
                                    <p>n위(<span class="rating">{{reservationRate}}</span>%)</p>
                                </div>
                                <div class="audience">
                                    <h5>누적관객수</h5>
                                    <p><span class="audience-counting">{{audienceCount}}</span>명</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="movie-cont-wrap">

                        <ul class="tab">
                            <li class="on">상세정보</li>
                            <li>관람평</li>
                            <li>예고편/스틸컷</li>
                        </ul>

                        <ul class="tab_cont">
                            <li class="on">
                                <div class="inner">
                                    <p class="movie-cont">{{{content}}}</p>
                                    <h4>관람객 평점</h4>
                                    <div class="row text-center">
                                        <div class="col-md-6">
                                            <div class="progress" style="height: 30px;">
                                                <div class="progress-bar bg-success" role="progressbar" style="width: {{positivePercentage}}%;"
                                                     aria-valuenow="{{positivePercentage}}" aria-valuemin="0" aria-valuemax="100">
                                                    {{positivePercentage}}%
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- 리뷰 목록 표시 부분 추가 -->
                                    <hr>
                                    {{#loginMember}}
                                        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#reviewModal" data-movie-id="{{movieId}}">
                                            리뷰 작성하기
                                        </button>
                                    {{/loginMember}}
                                    <h4 class="">{{title}}에 대한 {{reviews.size}}개의 이야기가 있어요!</h4>
                                    {{#reviews}}
                                        <div class="card mb-3">
                                            <div class="card-body">
                                                <div class="d-flex justify-content-between">
                                                    <h5 class="card-title">
                                                        {{#isPositive}}
                                                            <span class="badge bg-success"><i class="bi bi-hand-thumbs-up"></i> 좋았어요</span>
                                                        {{/isPositive}}
                                                        {{^isPositive}}
                                                            <span class="badge bg-danger"><i class="bi bi-hand-thumbs-down"></i> 별로였어요</span>
                                                        {{/isPositive}}
                                                    </h5>
                                                    <small class="text-muted">{{createdAt}}</small>
                                                </div>
                                                <strong>{{userName}}</strong>
                                                <p class="card-text">{{{content}}}</p>
                                                {{#deletable}}
                                                    <div class="d-flex justify-content-end">
                                                        <a href="/reviews/delete/{{reviewId}}?movieId={{movieId}}" class="btn btn-sm btn-outline-danger"
                                                        onclick="return confirm('정말로 이 리뷰를 삭제하시겠습니까?');">삭제</a>
                                                    </div>
                                                {{/deletable}}
                                            </div>
                                        </div>
                                    {{/reviews}}
                                    {{^reviews}}
                                        <div class="alert alert-info">
                                            아직 등록된 리뷰가 없습니다. 첫 번째 리뷰를 작성해보세요!
                                        </div>
                                    {{/reviews}}
                                </div>
                            </li>

                            <li class="">
                                <!-- 리뷰 목록 표시 부분 추가 -->
                                <hr>
                                {{#loginMember}}
                                    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#reviewModal" data-movie-id="{{movieId}}">
                                        리뷰 작성하기
                                    </button>
                                {{/loginMember}}
                                <h4 class="">{{title}}에 대한 {{reviews.size}}개의 이야기가 있어요!</h4>
                                {{#reviews}}
                                    <div class="card mb-3">
                                        <div class="card-body">
                                            <div class="d-flex justify-content-between">
                                                <h5 class="card-title">
                                                    {{#isPositive}}
                                                        <span class="badge bg-success"><i class="bi bi-hand-thumbs-up"></i> 좋았어요</span>
                                                    {{/isPositive}}
                                                    {{^isPositive}}
                                                        <span class="badge bg-danger"><i class="bi bi-hand-thumbs-down"></i> 별로였어요</span>
                                                    {{/isPositive}}
                                                </h5>
                                                <small class="text-muted">{{createdAt}}</small>
                                            </div>
                                            <strong>{{userName}}</strong>
                                            <p class="card-text">{{{content}}}</p>
                                            {{#deletable}}
                                                <div class="d-flex justify-content-end">
                                                    <a href="/reviews/delete/{{reviewId}}?movieId={{movieId}}" class="btn btn-sm btn-outline-danger"
                                                    onclick="return confirm('정말로 이 리뷰를 삭제하시겠습니까?');">삭제</a>
                                                </div>
                                            {{/deletable}}
                                        </div>
                                    </div>
                                {{/reviews}}
                                {{^reviews}}
                                    <div class="alert alert-info">
                                        아직 등록된 리뷰가 없습니다. 첫 번째 리뷰를 작성해보세요!
                                    </div>
                                {{/reviews}}
                            </li>

                            <li class="">
                                {{#videoUrl}}
                                    <hr>
                                    <h4>예고편</h4>
                                    <div class="embed-responsive embed-responsive-16by9 mb-3">
                                        <iframe class="embed-responsive-item" src="{{videoUrl}}" allowfullscreen
                                                style="width:100%; height:400px;"></iframe>
                                    </div>
                                {{/videoUrl}}
                                {{#subImageUrls}}
                                    <hr>
                                    <h4>서브 이미지</h4>
                                    <div class="detail-images-gallery">
                                        <div class="detail-image-item mb-3">
                                            <img src="/images/movie/{{subImageUrls}}" class="img-fluid rounded" alt="서브 이미지">
                                        </div>
                                    </div>
                                {{/subImageUrls}}
                                {{#detailImageUrls}}
                                    <hr>
                                    <h4>상세 이미지</h4>
                                    <div class="detail-images-gallery">
                                        {{#detailImageUrlList}}
                                            <div class="detail-image-item mb-3">
                                                <img src="/images/movie/{{.}}" class="img-fluid rounded" alt="상세 이미지">
                                            </div>
                                        {{/detailImageUrlList}}
                                    </div>
                                {{/detailImageUrls}}
                            </li>

                        </ul>

                        <hr>
                        등록일: <span class="format-date">{{createdAt}}</span><br>
                        수정일: <span class="format-date">{{updatedAt}}</span>

                    </div>
                    <div class="card-footer text-center">
                        <a href="/movies/{{movieId}}/edit" class="btn btn-primary me-2">수정하기</a>
                        <button type="button" class="btn btn-danger me-2" onclick="deleteMovie({{movieId}})">삭제하기
                        </button>
                        <a href="/movies" class="btn btn-secondary">목록으로 돌아가기</a>
                    </div>
                {{/movie}}
            </div>
        </div>
    </div>
</div>

<!-- 리뷰 작성 모달 -->
<div class="modal fade" id="reviewModal" tabindex="-1" aria-labelledby="reviewModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="reviewModalLabel">리뷰 작성</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">X</button>
            </div>
            <div class="modal-body" id="reviewFormContainer">
                <!-- 리뷰 폼 내용이 여기에 로드됩니다 -->
                리뷰 폼 여기 나옴
            </div>
        </div>
    </div>
</div>

<!-- Bootstrap JS 및 모달 로딩 스크립트 -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        var reviewModal = document.getElementById('reviewModal');
        reviewModal.addEventListener('show.bs.modal', function (event) {
            var button = event.relatedTarget; // 모달을 트리거한 버튼
            var movieId = button.getAttribute('data-movie-id'); // data-movie-id 속성에서 영화 ID 추출
            var reviewFormContainer = document.getElementById('reviewFormContainer');

            // AJAX 요청으로 폼 내용 불러오기
            fetch(`/reviews/new-fragment?movieId=${movieId}`) // 새로운 엔드포인트 호출
                .then(response => response.text())
                .then(html => {
                    reviewFormContainer.innerHTML = html;
                    // 만약 리뷰 폼에 스마트 에디터가 적용되어 있다면, 여기서 에디터를 다시 초기화하는 코드가 필요합니다.
                    // 예: if (typeof nhn !== 'undefined') { nhn.husky.EZCreator.createInIFrame(...) }
                })
                .catch(error => {
                    console.error('리뷰 폼을 불러오는데 실패했습니다:', error);
                    reviewFormContainer.innerHTML = '<p class="text-danger">리뷰 폼을 불러오는데 실패했습니다.</p>';
                });
        });

        // 모달이 닫힐 때 내용 초기화 (선택 사항)
        reviewModal.addEventListener('hidden.bs.modal', function () {
            document.getElementById('reviewFormContainer').innerHTML = '로딩 중...';
        });

        // 탭
        const tabHeaders = document.querySelectorAll('.tab li');
        const tabContents = document.querySelectorAll('.tab_cont li');

        // 각 탭 헤더(li)에 클릭 이벤트 리스너를 추가합니다.
        tabHeaders.forEach((header, index) => {
            header.addEventListener('click', function() {
                // 모든 탭 헤더에서 'on' 클래스를 제거합니다.
                tabHeaders.forEach(h => h.classList.remove('on'));
                // 클릭된 탭 헤더에 'on' 클래스를 추가합니다.
                this.classList.add('on');

                // 모든 탭 내용에서 'on' 클래스를 제거합니다.
                tabContents.forEach(content => content.classList.remove('on'));
                // 클릭된 탭 헤더에 해당하는 탭 내용에 'on' 클래스를 추가합니다.
                tabContents[index].classList.add('on');
            });
        });

        const container = document.querySelector('.container');

        if (!container) {
            console.error('container 요소를 찾을 수 없습니다.');
            return;
        }

        // 좋아요 버튼 클릭 이벤트 처리
        container.querySelectorAll(".heart-button").forEach((button) => {
            // 새로 추가되는 요소에만 이벤트 리스너를 추가하는 것이 일반적이지만,
            // 여기서는 container 전체를 다시 스캔하여 적용합니다.
            // (이미 리스너가 있는 경우 중복 추가될 수 있으나, 대부분의 경우 문제가 되지 않습니다.)
            button.addEventListener("click", (event) => {
                button.classList.toggle("active");
            });
        });

        // 좋아요 개수를 표시하는 모든 span 요소
        container.querySelectorAll('.likesCount').forEach(function(element) {
            const count = parseInt(element.textContent);
            if (!isNaN(count)) {
                element.textContent = formatNumber(count);
            }
        });

    });
</script>

<script>
    function deleteMovie(movieId) {
        // 사용자에게 삭제 여부 확인
        if (confirm('정말로 이 영화를 삭제하시겠습니까?')) {
            // fetch API를 사용하여 DELETE 요청 전송
            fetch(`/api/movies/${movieId}`, {
                method: 'DELETE'
            })
            .then(response => {
                if (response.ok) { // HTTP 상태 코드가 200-299 범위인 경우 (성공)
                    alert('영화를 성공적으로 삭제했습니다.');
                    window.location.href = '/movies'; // 영화 목록 페이지로 리다이렉트
                } else {
                    // 오류 응답 처리
                    alert('영화 삭제에 실패했습니다. 다시 시도해주세요.');
                    console.error('삭제 실패:', response.status, response.statusText);
                }
            })
            .catch(error => {
                // 네트워크 오류 등 예외 처리
                alert('영화 삭제 중 오류가 발생했습니다.');
                console.error('삭제 중 오류 발생:', error);
            });
        }
    }

    // 'rating' 클래스를 가진 모든 요소를 찾아서 소수점 첫째 자리까지만 표시
    const ratingElements = document.querySelectorAll('.rating');

    ratingElements.forEach(function(element) {
        const text = element.textContent;
        const value = parseFloat(text);

        if (!isNaN(value)) {
          // 소수점 첫째 자리까지만 표시 (둘째 자리에서 버림)
          const truncatedValue = Math.floor(value * 10) / 10;

          // % 기호가 있는지 확인하여 유지
          if (text.includes('%')) {
            element.textContent = truncatedValue + '%';
          } else {
            element.textContent = truncatedValue;
          }
        }
    });

    // 날짜 형식을 변환하는 함수
    function formatDate(dateString) {
        if (!dateString) return '';

        // ISO 형식의 날짜 문자열에서 'T'를 기준으로 분할하여 날짜 부분만 추출
        const datePart = dateString.split('T')[0];
        return datePart.replaceAll('-', '.');
    }

    // .format-date 클래스를 가진 모든 요소 찾기
    const dateElements = document.querySelectorAll('.format-date');

    // 각 요소의 텍스트 내용을 변환
    dateElements.forEach(function(element) {
        const originalDate = element.textContent;
        if (originalDate && originalDate.trim() !== '') {
          element.textContent = formatDate(originalDate);
        }
    });
</script>

{{> common/footer }}